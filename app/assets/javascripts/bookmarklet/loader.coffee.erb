load_style = (path) ->
  style = document.createElement("link")
  style.type = "text/css"
  style.rel  = "stylesheet"
  style.href = path
  document.getElementsByTagName("head")[0].appendChild(style)

load_style "//<%= DOMAIN %>/assets/bookmarklet/loader.css"
load_style "//<%= DOMAIN %>/assets/jquery/mentionsInput.css"

<% ['head'].each do |lib| %>
`<%= IO.read("#{Rails.root}/app/assets/javascripts/libs/#{lib}.js").gsub('`','\\\\`') %>`
<% end %>

head.js {jquery:  "//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"},
  {underscore:    "//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"},
  {backbone:      "//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"},
  {humane:        "//<%= DOMAIN %>/assets/cdn/jquery/humane.js"},
  {elastic:       "//<%= DOMAIN %>/assets/cdn/jquery/elastic.js"},
  {input_polyfill:"//<%= DOMAIN %>/assets/cdn/jquery/events.input.js"},
  {mentions:      "//<%= DOMAIN %>/assets/cdn/jquery/mentionsInput.js"},
  {handlbars:     "//<%= DOMAIN %>/assets/cdn/handlebars.js"},
  {keymaster:     "//<%= DOMAIN %>/assets/cdn/keymaster.js"},
  {twitter_text:  "//<%= DOMAIN %>/assets/cdn/twitter-text.js"},
  {core:          "//<%= DOMAIN %>/assets/bookmarklet/core.js"}
, ->

  #-----------------------------------------
  # Config Vars

  reading.ready = false
  on_reading = window.location.host.indexOf("reading.am") is 0 or
               window.location.host.indexOf("staging.reading.am") is 0 or
               window.location.host.indexOf("0.0.0.0") is 0
  token = reading.token ? null
  platform = reading.platform ? (if on_reading then "redirect" else "bookmarklet")
  version = reading.version ? "0.0.0"

  latest_versions =
    bookmarklet: "<%= BOOKMARKLET_VERSION %>"

  #-----------------------------------------
  # Helpers

  parse_url = ->
    url = window.location.href.split(window.location.host)[1].substring(1)
    while url.substring(0, 2) is 't/' or url.substring(0, 2) is 'p/'
      url = url.substring(url.indexOf('/', 2) + 1)
    url = "http://#{url}" if url.indexOf('://') is -1
    url

  popup = (url, width, height) ->
    window.open url, "r_win", "location=0,toolbars=0,status=0,directories=0,menubar=0,resizable=0,width=#{width},height=#{height}"

  Handlebars.registerHelper "nl2br", (context, fn) ->
    new Handlebars.SafeString (context+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, "$1<br>$2")

  Handlebars.registerHelper "autolink", (context, fn) ->
    new Handlebars.SafeString twttr.txt.autoLink context,
        urlClass:       "r_url",
        usernameClass:  "r_mention",
        hashtagClass:   "r_tag",
        usernameUrlBase:"//<%= DOMAIN %>/",
        listUrlBase:    "//<%= DOMAIN %>/",
        hashtagUrlBase: "//<%= DOMAIN %>/search?q="

  Handlebars.registerHelper "embed_images", (context, fn) ->
    $context = ø.$("<div>#{context}</div>")
    $context.find("a[href$=#{["jpg","jpeg","png","gif"].join("],a[href$=")}]").each ->
      $this = ø.$(this)
      $this.html("<img src=\"#{$this.attr("href")}\">")
    new Handlebars.SafeString $context.html()

  Handlebars.registerHelper 'format_comment', (context, fn) ->
    context = Handlebars.helpers.nl2br.call this, context, fn
    context = Handlebars.helpers.autolink.call this, context.string, fn
    context = Handlebars.helpers.embed_images.call this, context.string, fn
    context

  #######
  # API #
  #######
  class API

  API::call = (method, params) ->
      data = if params.data? then params.data else {}
      data.token = token if token

      complete = if params.complete? then params.complete else ->
      success = if params.success? then params.success else log
      error = if params.error? then params.error else (jqXHR, textStatus, errorThrown) ->
        log jqXHR, textStatus, errorThrown
        switch errorThrown
          when "Bad Request"
            alert ø.Errors.general
          when "Forbidden"
            alert ø.Errors.forbidden

      ø.$.ajax
        url: "//<%= DOMAIN %>/#{method}.json"
        dataType: "jsonp"
        data: data
        complete: complete
        error: error
        success: (data, textStatus, jqXHR) ->
          if data.meta.status < 400
            success ø.Backbone.Model::factory(data.response)
          else
            jqXHR.status = data.meta.status
            jqXHR.responseText = data
            error jqXHR, textStatus, data.meta.msg

  #-----------------------------------------
  # Submit the post

  reading.submit = submit = (params) ->
    post = ø.Models.Post::current = new ø.Models.Post
    post.save params, success: (data) ->
      if platform is "redirect"
        # forward back through to Reading so that the user's token doesn't show up in the referrer
        window.location = if window.location.href.indexOf('/t/') > -1 then "http://<%= DOMAIN %>/t/-/#{params.url}" else params.url

    ø.Views.BookmarkletApp::current.close() if ø.Views.BookmarkletApp::current?
    ø.Views.BookmarkletApp::current = new ø.Views.BookmarkletApp model: post if platform isnt "redirect"

  #-----------------------------------------
  # Initialize!

  init = ->
    # fire an event to let people know reading is ready
    # can't seem to use jquery.trigger for events attached
    # without jquery
    e = document.createEvent "Event"
    e.initEvent "reading.ready", true, true
    document.dispatchEvent e
    reading.ready = true

    win_focus = true
    ø.$(window).focus(-> win_focus = true).blur(-> win_focus = false)
    ø.$.fn.hasFocus = -> win_focus

    if platform is "redirect" or platform is "bookmarklet"
      if platform is "redirect"
        url   = parse_url()
        title = null
        return window.location = url if token is "-" or !token
      else
        url   = window.location.href
        title = window.document.title

      submit
        url: url
        title: title
        referrer_id: reading.referrer_id ? 0


  #-----------------------------------------
  # Check the bookmarklet version

  up_to_date = ->
    !latest_versions[platform]? || String(version).replace(/\./g,'') >= String(latest_versions[platform]).replace(/\./g,'')

  #-----------------------------------------
  # Prompt to upgrade

  upgrade = -> ø.$.getScript "//<%= DOMAIN %>/assets/bookmarklet/upgrade.js"

  #-----------------------------------------
  # Check for jQuery and initialize

  if up_to_date() then init() else upgrade()
