<%= render :partial => 'users/settings_subnav' if @user == current_user %>

<%= render :partial => 'layouts/notice', :locals => {:notice => notice} %>

<%=
locals = mustache_helpers.merge({
    apps:     bot? ? @apps : false,
    has_apps: @apps.to_a.size > 0 # run the query first with to_a so that it doesn't make a count() query
  })

  render file: 'oauth_apps/index/template', locals: locals
%>

<% if !bot? %>

<script>

<%
# NOTE: we're basically overriding the backbone/router partial view
# in order to add the consumer_secret to the json

props = {
  model: @user.simple_obj,
  collection: @apps.collect do |v|
    obj = v.simple_obj
    obj[:consumer_secret] = v.secret if v.owner == current_user
    obj
  end
}
%>

<%= requirejs %>(["backbone", "app/routers/users"], function(Backbone, Router){
  new Router({<% props.each_with_index do |key, i| %>
      "<%= key[0] %>": Backbone.Model.prototype.factory(<%=j key[1].to_json.html_safe -%>)<%= ',' if i < props.length-1 %>
    <% end %>});
  Backbone.history.start({pushState: true});
});

</script>

<% end %>
