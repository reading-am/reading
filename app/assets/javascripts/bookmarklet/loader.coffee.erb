load_style = (path) ->
  style = document.createElement("link")
  style.type = "text/css"
  style.rel  = "stylesheet"
  style.href = path
  document.getElementsByTagName("head")[0].appendChild(style)

load_style "//<%= DOMAIN %>/assets/bookmarklet/loader.css"
load_style "//<%= DOMAIN %>/assets/jquery/mentionsInput.css"

<% ['head'].each do |lib| %>
`<%= IO.read("#{Rails.root}/app/assets/javascripts/libs/#{lib}.js").gsub('`','\\\\`') %>`
<% end %>

head.js {jquery:  "//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"},
  {underscore:    "//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js"},
  {backbone:      "//cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"},
  {humane:        "//<%= DOMAIN %>/assets/cdn/jquery/humane.js"},
  {elastic:       "//<%= DOMAIN %>/assets/cdn/jquery/elastic.js"},
  {input_polyfill:"//<%= DOMAIN %>/assets/cdn/jquery/events.input.js"},
  {mentions:      "//<%= DOMAIN %>/assets/cdn/jquery/mentionsInput.js"},
  {handlbars:     "//<%= DOMAIN %>/assets/cdn/handlebars.js"},
  {keymaster:     "//<%= DOMAIN %>/assets/cdn/keymaster.js"},
  {twitter_text:  "//<%= DOMAIN %>/assets/cdn/twitter-text.js"},
  {core:          "//<%= DOMAIN %>/assets/bookmarklet/core.js"}
, ->

  #-----------------------------------------
  # Config Vars

  reading.ready = false
  on_reading = window.location.host.indexOf("reading.am") is 0 or
               window.location.host.indexOf("staging.reading.am") is 0 or
               window.location.host.indexOf("0.0.0.0") is 0
  token = reading.token ? null
  platform = reading.platform ? (if on_reading then "redirect" else "bookmarklet")
  version = reading.version ? "0.0.0"

  latest_versions =
    bookmarklet: "<%= BOOKMARKLET_VERSION %>"

  #-----------------------------------------
  # Content Vars

  active = "r_active"
  inactive = "r_inactive"
  errors =
    general: "Sorry, something went wrong. If you keep getting this error, would you mind letting us know at hello@reading.am?"
    forbidden: "** You must be signed in to post to Reading **\nSign in or create an account at http://<%= DOMAIN %>"
    loading: "Sorry, we were unable to load ø. If you keep getting this error, would you mind letting us know at hello@reading.am?"

  #-----------------------------------------
  # Helpers

  parse_url = ->
    url = window.location.href.split(window.location.host)[1].substring(1)
    while url.substring(0, 2) is 't/' or url.substring(0, 2) is 'p/'
      url = url.substring(url.indexOf('/', 2) + 1)
    url = "http://#{url}" if url.indexOf('://') is -1
    url

  popup = (url, width, height) ->
    window.open url, "r_win", "location=0,toolbars=0,status=0,directories=0,menubar=0,resizable=0,width=#{width},height=#{height}"

  Handlebars.registerHelper "nl2br", (context, fn) ->
    new Handlebars.SafeString (context+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, "$1<br>$2")

  Handlebars.registerHelper "autolink", (context, fn) ->
    new Handlebars.SafeString twttr.txt.autoLink context,
        urlClass:       "r_url",
        usernameClass:  "r_mention",
        hashtagClass:   "r_tag",
        usernameUrlBase:"//<%= DOMAIN %>/",
        listUrlBase:    "//<%= DOMAIN %>/",
        hashtagUrlBase: "//<%= DOMAIN %>/search?q="

  Handlebars.registerHelper "embed_images", (context, fn) ->
    $context = ø.$("<div>#{context}</div>")
    $context.find("a[href$=#{["jpg","jpeg","png","gif"].join("],a[href$=")}]").each ->
      $this = ø.$(this)
      $this.html("<img src=\"#{$this.attr("href")}\">")
    new Handlebars.SafeString $context.html()

  Handlebars.registerHelper 'format_comment', (context, fn) ->
    context = Handlebars.helpers.nl2br.call this, context, fn
    context = Handlebars.helpers.autolink.call this, context.string, fn
    context = Handlebars.helpers.embed_images.call this, context.string, fn
    context



  #-----------------------------------------
  # Sync for JSONP



  #-----------------------------------------
  # Models

  #######
  # API #
  #######
  class API

  API::call = (method, params) ->
      data = if params.data? then params.data else {}
      data.token = token if token

      complete = if params.complete? then params.complete else ->
      success = if params.success? then params.success else log
      error = if params.error? then params.error else (jqXHR, textStatus, errorThrown) ->
        log jqXHR, textStatus, errorThrown
        switch errorThrown
          when "Bad Request"
            alert errors.general
          when "Forbidden"
            alert errors.forbidden

      ø.$.ajax
        url: "//<%= DOMAIN %>/#{method}.json"
        dataType: "jsonp"
        data: data
        complete: complete
        error: error
        success: (data, textStatus, jqXHR) ->
          if data.meta.status < 400
            success ø.Backbone.Model::factory(data.response)
          else
            jqXHR.status = data.meta.status
            jqXHR.responseText = data
            error jqXHR, textStatus, data.meta.msg

  #-----------------------------------------
  # Views


  class ø.Views.App extends ø.Backbone.View
    template: Handlebars.compile "
      <div id=\"r_wrp\">
        <div id=\"r_icon\">&#9996;</div>
        <div id=\"r_subtext\">Loading</div>
        <div id=\"r_actions\">
          <a href=\"#\" id=\"r_yep\">Yep</a> .
          <a href=\"#\" id=\"r_nope\">Nope</a>
          <a href=\"#\" id=\"r_share\">Share</a>
          <a href=\"#\" id=\"r_close\">&#10005;</a>
        </div>
      </div>"

    tagName: "div"

    id: "r_am"

    events:
      "click #r_yep, #r_nope" : "set_yn"
      "mouseenter #r_share" : "show_share"
      "mouseleave, mouseleave #r_share" : "hide_share"
      "mouseleave" : "hide_share"
      "mouseenter #r_actions a:not(#r_share)" : "hide_share"
      "click #r_close" : "close"

    initialize: ->
      @model.bind "change:yn", @render_yn, this
      @model.bind "change:id", @get_comments, this
      @model.bind "change:id", @get_readers, this

      @render()

      @intervals "add", 15, => @$("time").humaneDates()

      @share_view = new ø.Views.Providers.ProvidersView
        id: "r_share_menu"
        collection: providers
      @$("#r_wrp").after(@share_view.render().el)

      # prevent # from showing up in the url
      # can't bind in events because of conflicts
      @$el.on "click", "a[href=#]", -> false

      @$el.prependTo("body").fadeIn 500

      @$("#r_wrp").delay(500).animate
        height: "29px"
        width: @$("#r_actions").width()

      @$("#r_icon").delay(500).animate "margin-top": "-56px"

    get_comments: ->
      @comments_view = new ø.Views.Comments.CommentsView
        id: "r_comments"
        collection: @model.get("page").comments

      @comments_view.collection.fetch()
      @$el.append(@comments_view.render().el)

      @comments_view.attach_autocomplete()

    get_readers: ->
      @readers_view = new ø.Views.Users.UsersView
        id: "r_readers"
        collection: @model.get("page").users

      @readers_view.collection.fetch()
      @$("#r_wrp").after(@readers_view.render().$el.prepend("<li id=\"r_other\">&#8258; Other Readers</li>"))
      @readers_view.$el.slideDown()

    set_yn: (e) ->
      $tar = ø.$(e.target)
      @model.save
        yn: (if $tar.hasClass(active) then null else $tar.is("#r_yep"))

    render_yn: ->
      $this  = (if @model.get("yn") then @$("#r_yep") else @$("#r_nope"))
      $other = (if @model.get("yn") then @$("#r_nope") else @$("#r_yep"))

      # set the UI
      if @model.get("yn") is null
        $this.removeClass "#{active} #{inactive}"
        $other.removeClass "#{active} #{inactive}"
      else
        $this.removeClass(inactive).addClass active
        $other.removeClass(active).addClass inactive

    show_share: ->
      @share_view.$el.show()
      @readers_view.$el.hide()
      ø.$('#r_share').addClass "r_active"
      false

    hide_share: ->
      @share_view.$el.hide()
      @readers_view.$el.show()
      ø.$('#r_share').removeClass "r_active"
      false

    close: ->
      @intervals "clear"
      @model.intervals "clear"
      @$el.fadeOut 400, =>
        @$el.remove()
      false

    render: =>
      @$el.html(@template(@model.toJSON()))
      return this

  #-----------------------------------------
  # Vars

  providers = new ø.Collections.Providers [
    new ø.Models.Provider
      name: "Twitter"
      url_scheme: "https://twitter.com/share?url={{short_url}}&text=✌%20Reading%20%22{{title}}%22"
      action: (url) ->
        popup url, 475, 345
    new ø.Models.Provider
      name: "Facebook"
      url_scheme: "https://www.facebook.com/sharer.php?u={{wrapped_url}}&t={{title}}"
      action: (url) ->
        popup url, 520, 370
    new ø.Models.Provider
      name: "Tumblr"
      url_scheme: "http://www.tumblr.com/share?v=3&u={{wrapped_url}}&t=✌%20Reading%20%22{{title}}%22"
      action: (url) ->
        popup url, 450, 430
    new ø.Models.Provider
      name: "Instapaper"
      url_scheme: "http://www.instapaper.com/hello2?url={{url}}&title={{title}}"
      action: (url) ->
        window.location = url
    new ø.Models.Provider
      name: "Readability"
      url_scheme: "http://www.readability.com/save?url={{url}}"
      action: (url) ->
        window.location = url
    new ø.Models.Provider
      name: "Pocket"
      url_scheme: "https://getpocket.com/save?url={{url}}&title={{title}}"
      action: (url) ->
        popup url, 490, 400
    new ø.Models.Provider
      name: "Pinboard"
      url_scheme: "https://pinboard.in/add?showtags=yes&url={{url}}&title={{title}}&tags=ø.am"
      action: (url) ->
        popup url, 490, 400
    new ø.Models.Provider
      name: "Email"
      url_scheme: "mailto:?subject=✌%20Reading%20%22{{title}}%22&body={{wrapped_url}}"
      action: (url) ->
        window.location.href = url
  ]

  #-----------------------------------------
  # Submit the post

  reading.submit = submit = (params) ->
    post = ø.Models.Post::current = new ø.Models.Post
    post.save params, success: (data) ->
      if platform is "redirect"
        # forward back through to Reading so that the user's token doesn't show up in the referrer
        window.location = if window.location.href.indexOf('/t/') > -1 then "http://<%= DOMAIN %>/t/-/#{params.url}" else params.url

    ø.Views.App::current.close() if ø.Views.App::current?
    ø.Views.App::current = new ø.Views.App model: post if platform isnt "redirect"

  #-----------------------------------------
  # Initialize!

  init = ->
    # fire an event to let people know reading is ready
    # can't seem to use jquery.trigger for events attached
    # without jquery
    e = document.createEvent "Event"
    e.initEvent "reading.ready", true, true
    document.dispatchEvent e
    reading.ready = true

    win_focus = true
    ø.$(window).focus(-> win_focus = true).blur(-> win_focus = false)
    ø.$.fn.hasFocus = -> win_focus

    if platform is "redirect" or platform is "bookmarklet"
      if platform is "redirect"
        url   = parse_url()
        title = null
        return window.location = url if token is "-" or !token
      else
        url   = window.location.href
        title = window.document.title

      submit
        url: url
        title: title
        referrer_id: reading.referrer_id ? 0


  #-----------------------------------------
  # Check the bookmarklet version

  up_to_date = ->
    !latest_versions[platform]? || String(version).replace(/\./g,'') >= String(latest_versions[platform]).replace(/\./g,'')

  #-----------------------------------------
  # Prompt to upgrade

  upgrade = -> ø.$.getScript "//<%= DOMAIN %>/assets/bookmarklet/upgrade.js"

  #-----------------------------------------
  # Check for jQuery and initialize

  if up_to_date() then init() else upgrade()
