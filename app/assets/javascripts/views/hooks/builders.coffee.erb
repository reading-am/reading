field = (param, scope, add_label) ->
  param.name = param.text.toLowerCase().replace(RegExp(" ", "g"), "_")  unless param.name
  param.scoped_name = scope + "[" + param.name + "]"  if scope
  param.id = param.scoped_name.toLowerCase().replace(/\[/g, "_").replace(/\]/g, "")  unless param.id
  func = (if param.options then select_field else text_field)
  $field = $("<span class=\"control-group\">")
  $field.append " <label for=\"#{param.id}\">#{param.text}</label> " if add_label or typeof add_label is "undefined"
  $field.append func(param)

select_field = (param) ->
  $select = $("<select>").attr("name", param.scoped_name).attr("id", param.id)
  $select.attr "data-type", param.datatype  if param.datatype
  i = 0

  while i < param.options.length
    op = (if typeof param.options[i] is "string" then text: param.options[i] else param.options[i])
    op.value = op.text.toLowerCase()  unless op.value
    $select.append $("<option>").val(op.value).text((if op.text then op.text else op.value))
    i++
  $select.append $("<option>").val("new").text("+ connect new")  if param.datatype is "account"
  $select

text_field = (param) ->
  $input = (" <input type=\"text\" name=\"#{param.scoped_name}\" id=\"#{param.id}\" placeholder=\"#{(if param.placeholder then param.placeholder else param.name)}\"> ")
  $input.attr "data-type", param.datatype  if param.datatype
  $("<span class=\"control-group\">").append $input

build_provider = (prov) ->
  $prov = $("<span>").attr("id", "provider_params")
  i = 0
  while i < prov.params.length
    $prov.append " using " if i is 1
    $prov.append "<br>"    if i is 2
    $prov.append " and "   if i > 1
    $prov.append field(prov.params[i], "hook[params]")
    i++
  $prov.append "<input type=\"hidden\" name=\"permission\" value=\"#{prov.permission or ''}\" id=\"hook_params_permission\">"
  populate_accounts $("#hook_provider").val(), $("[data-type=\"account\"] option[value!=\"new\"]", $prov)
  $prov
