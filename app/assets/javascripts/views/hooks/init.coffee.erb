<% include_path = "#{Rails.root}/app/assets/javascripts/views/hooks" %>
<%= ERB.new(IO.read "#{include_path}/properties.coffee.erb").result %>
<%= ERB.new(IO.read "#{include_path}/builders.coffee.erb").result %>
<%= ERB.new(IO.read "#{include_path}/serializers.coffee.erb").result %>

errors =
  AuthFailure: "You chose not to give us access to your details"
  AuthWrongAccount: "To modify that account, you'll need to log into it first"
  AuthPreexisting: "You tried to connect a new account but you're logged in to one of your other accounts"
  AuthTaken: "That account is connected to a different Reading account"
  AuthSaveFail: "There was an error saving your account. Please try again."

# endpoints to get user data from each provider
api_urls =
  twitter: "https://api.twitter.com/1/users/show.json?id="
  facebook: "https://graph.facebook.com/"

# replace external account ids with their usernames
populate_accounts = (provider, selection) ->
  selection.each ->
    $this = $(this)
    $.ajax
      url: api_urls[provider] + $this.text()
      dataType: "jsonp"
      success: (r) ->
        if r.screen_name
          $this.text (if provider is "twitter" then "@" else "") + r.screen_name
        else if r.username
          $this.text r.username
        else $this.text r.name  if r.name

$ ->
  # build the constructor with the initial selection
  $con = $('#constructor')
  $(".wrapper", $con)
    .append("When I ").append(field({text: "events", options: hook_properties.events}, "hook", false))
    .append(" please post to the ").append(field({text: "provider", options: hook_properties.providers}, "hook", false))
    .append "<span id=\"provider_params\">"

  # switch out and link the footnotes explaining a hook
  $("select[name='hook[provider]']", $con).change(->
    $this = $(this)
    $(".footnote").data "url", "/footnotes/" + $this.val()
    $("#provider_params").replaceWith build_provider(hook_properties.providers[$this.prop("selectedIndex")].params)
  ).change()

  # populate the auth spans with real usernames
  populate_accounts "twitter", $(".provider.twitter .account")
  populate_accounts "facebook", $(".provider.facebook .account")

  cpath = {path: "/"}

  #########################
  # Procees New Hook Form #
  #########################
  $("#new_hook").on "submit", ->
    # setup
    $this = $(this)
    provider = $("#hook_provider").val()
    account  = $("#hook_params_account").val()

    if account is "new"
      # User is trying to add a new account
      auth = new window["#{provider[0].toUpperCase()}#{provider[1..]}Auth"]("new", ["read","write"])
      auth.login
        success: (response) ->
          $("#hook_params_account option[value='new']").val auth.uid
          $this.submit()
        error: (response) ->
          alert errors[response.status]
      false # stop submit
    else if account
      # User is adding a hook to an existing account
      auth = current_user.authorizations[provider][account]
      unless auth.can "write"
        auth.ask_permission "write", ->
          $this.submit()
        , ->
          alert 'There was an error getting permission to post to that account'

        false # stop submit
